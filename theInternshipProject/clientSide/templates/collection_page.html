<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ collection }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
     <style>
        /* General Theme Changes */
        body {
            background-image: url('/static/logo.png'); /* Replace with the path to your logo */
            background-repeat: no-repeat;
            background-position: center center; /* Adjust position if needed */
            background-size: 40%; /* Adjust size as needed */
            background-attachment: fixed;
            background-color: #f8f9fa;
            color: #212529;
            font-family: 'Roboto', sans-serif;
            overflow-x: hidden;
        }

         body::before { /* Apply overlay */
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 249, 250, 0.6); /* Light white overlay with transparency */
            z-index: -1;
        }

        .container {
            max-width: 90vw;
            margin: 0 auto;
            padding-top: 2rem;
            padding-bottom: 2rem;
        }

        /* Card Styles */
        .card {
            background: #fff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin-bottom: 2rem;
            border: none;

        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
             background-color: #f0f0f0;
             color: #212529;
             border-bottom: 1px solid #e0e0e0;
            padding: 1rem 1.5rem;
            border-radius: 8px 8px 0 0;
            position: relative;
        }
        .card-header h2 {
            margin-bottom: 0;
              flex-grow: 1;
        }

        .card-body {
            padding: 1.5rem;
        }

        h1, h2 {
            color: #212529;
            margin-bottom: 1.5rem;
            font-weight: 500;
        }


        /* Table Styles */
        .table {
            margin-bottom: 1.5rem;
            overflow-x: auto;
            display: block;
        }

        .table th {
            background-color: #e0e0e0;
             color: #212529;
            font-weight: 500;
             border-bottom: 2px solid #d0d0d0;
        }

        .table td {
           background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            white-space: pre-wrap;
        }

        .table-bordered th,
        .table-bordered td {
            border-color: #e0e0e0;
        }

        /* Button Styles */
        .btn-primary {
             background-color: #a3a38c;
            border-color: #a3a38c;
        }

        .btn-primary:hover {
             background-color: #90907c;
            border-color: #90907c;
        }

        .btn-warning {
             background-color: #f0c78a;
            border-color: #f0c78a;
            color: #212529;
        }

        .btn-warning:hover {
           background-color: #e2b371;
            border-color: #e2b371;
             color: #212529;
        }

        .btn-danger {
            background-color: #e77e6c;
            border-color: #e77e6c;
        }

        .btn-danger:hover {
             background-color: #d86a58;
            border-color: #d86a58;
        }

        .btn-success {
             background-color: #8cb370;
            border-color: #8cb370;
        }

        .btn-success:hover {
             background-color: #7da460;
            border-color: #7da460;
        }

        .btn {
            border-radius: 6px;
            font-weight: 500;
            padding: 0.4rem .8rem;
        }

       /* Modal Styles */
        .modal-content {
            border-radius: 8px;
        }

        .modal-header {
           background-color: #f0f0f0;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 8px 8px 0 0;
        }

        .modal-title {
            color: #212529;
        }

        .modal-body {
            padding: 1.5rem;
        }

        .modal-footer {
            border-top: 1px solid #e0e0e0;
            padding: 1.5rem;
        }


       /* Form Control Styles */
        .form-control {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            background-color: #fff;
            color: #212529;
             white-space: pre-wrap;
        }

        .form-control:focus {
            border-color: #a3a38c;
            box-shadow: 0 0 0 0.25rem rgba(163, 163, 140, 0.25);
        }


        /* Toast Styles */
        .toast-container {
            z-index: 1050;
        }

        .toast {
            background-color: #b3d89c;
            border-radius: 8px;
             color: #212529;
        }

        .toast .btn-close {
            filter: invert(1);
        }

        .key-edit-form {
            position: absolute;
            top: 5px;
            right: 40px;
            display: none;

        }
        .key-edit-form.show {
            display: block;
        }
        .edit-key-btn,
        .delete-key-btn {
            padding: 0;
            background-color: transparent;
            border: none;
            cursor: pointer;
            margin-left: 0.5rem;
            margin-right: 0.2rem;

        }

        .edit-key-btn:hover,
        .delete-key-btn:hover{
              color: #a3a38c;
        }

        .form-container {
            position: relative;

        }
        .key-header {
            position: relative;
            padding-right: 1.5rem;
        }

        .action-buttons-container {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }

        .action-buttons-container  .btn {
            min-width: 3rem;
        }

        .key-text {
            padding-right: 1.5rem;
        }
       .nested-list-box{
             border: 1px solid #a3a38c;
            padding: 0.5rem;
            margin: 0.2rem 0;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
         .nested-container {
          padding-right: 0.2rem;
        }
         .data-type {
            font-size: 0.8em;
            color: #6c757d;
           margin-left:0.2rem;
        }
        @media (max-width: 768px) {
            .container{
                max-width: 98vw;
            }
        }


    </style>
</head>
<body>
<div class="container">
    <div class="d-flex justify-content-between align-items-center">
        <h1 class="mb-0">{{ collection }}</h1>
        <a href="/" class="btn btn-secondary">Go Back</a>
    </div>
    <!-- Bootstrap Toast -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body" id="toastMessage">
                    Action completed successfully!
                </div>
                <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    </div>
      <!-- Search Collection Keys -->
      <div class="card">
         <div class="card-body">
           <div class="form-container">
                <form action="/collection/{{ collection }}" method="POST" class="d-flex gap-2" >
                    <input type="text" class="form-control" name="search_key" placeholder="Search Keys" value="{{ search_term if search_term }}" >
                    <button class="btn btn-primary" type="submit">Search</button>
                </form>
            </div>
         </div>
       </div>
    <!-- Null collections-->
    {% if not items %}
        <div class="card">
            <div class="card-header">
                <h2>{{ collection }}</h2>
            </div>
            <div class="card-body">
                <p> This Collection is Empty, Please enter keys and values</p>
                <div class="form-container">
                    <form id="addNullCollectionForm{{collection}}" action="/add_null_collection/{{ collection }}" method="POST" class="d-flex gap-2" onsubmit="showToast('Keys Added Successfully')">
                        <input type="hidden" name="collection_name" value="{{ collection }}">
                        <div id="new-keys-fields{{collection}}" >
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="addKeyInput('{{collection}}')">Add Key</button>
                        <button type="submit" class="btn btn-success">Add</button>
                    </form>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">{{ collection }}</h2>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                    <tr>
                         {% if filtered_keys %}
                             {% for key in filtered_keys %}
                                 <th class="key-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                       <span class="key-text"> {{ key }}
                                             {% if key in key_types %}
                                                    <small>({{ key_types[key] }})</small>
                                                {% endif %}
                                        </span>
                                       <div>
                                          <button class="edit-key-btn"  onclick="toggleKeyRenameForm('{{ collection }}', '{{key}}', this)"><i class="fas fa-edit"></i></button>
                                          <form action="/delete_key/{{ collection }}/{{ key }}" method="POST" style="display: inline;" onsubmit="return confirmDeleteKey()">
                                             <button type="submit" class="delete-key-btn" ><i class="fas fa-trash"></i></button>
                                          </form>
                                        </div>
                                    </div>
                                    <form  id="renameKeyForm{{collection}}{{key}}" class="key-edit-form" action="/rename_key/{{ collection }}/{{ key }}" method="POST"  onsubmit="return confirmRenameKey(this)">
                                      <div class="mb-2 d-flex gap-2">
                                         <input type="text" class="form-control form-control-sm" name="new_key" placeholder="New key" value="{{key}}"  required>
                                         <button class="btn btn-success btn-sm" type="submit">save</button>
                                       </div>
                                    </form>
                                 </th>
                            {% endfor %}
                         {% else %}
                                {% for key in keys %}
                                      <th class="key-header">
                                      <div class="d-flex justify-content-between align-items-center">
                                         <span class="key-text"> {{ key }}
                                             {% if key in key_types %}
                                                 <small>({{ key_types[key] }})</small>
                                             {% endif %}
                                         </span>
                                         <div>
                                               <button class="edit-key-btn"  onclick="toggleKeyRenameForm('{{ collection }}', '{{key}}', this)"><i class="fas fa-edit"></i></button>
                                            <form action="/delete_key/{{ collection }}/{{ key }}" method="POST" style="display: inline;" onsubmit="return confirmDeleteKey()">
                                                <button type="submit" class="delete-key-btn" ><i class="fas fa-trash"></i></button>
                                           </form>
                                       </div>
                                     </div>
                                     <form  id="renameKeyForm{{collection}}{{key}}" class="key-edit-form" action="/rename_key/{{ collection }}/{{ key }}" method="POST"  onsubmit="return confirmRenameKey(this)">
                                          <div class="mb-2 d-flex gap-2">
                                            <input type="text" class="form-control form-control-sm" name="new_key" placeholder="New key" value="{{key}}"  required>
                                           <button class="btn btn-success btn-sm" type="submit">save</button>
                                        </div>
                                      </form>
                                   </th>
                             {% endfor %}
                       {% endif %}
                       <th style="width:10%">Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for item in items %}
                        <tr>
                             {% if filtered_keys %}
                                  {% for key in filtered_keys %}
                                        <td class="nested-container">
                                           <div>{{ item.get(key) | truncate(70) | render_nested(key_types) | safe if key in item else '' }}</div>
                                       </td>
                                  {% endfor %}
                                  {% else %}
                                     {% for key in keys %}
                                           <td class="nested-container">
                                                <div>{{ item.get(key) | truncate(70) | render_nested(key_types) | safe if key in item else '' }}</div>
                                            </td>
                                      {% endfor %}
                            {% endif %}
                            <td class="action-buttons-container">
                                <!-- Edit Button -->
                                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal{{ item._id }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <!-- Delete Form -->
                                <form action="/delete/{{ collection }}/{{ item._id }}" method="POST" style="display: inline;" onsubmit="return confirmDelete()">
                                    <button type="submit" class="btn btn-danger btn-sm" ><i class="fas fa-trash"></i></button>
                                </form>
                            </td>
                        </tr>
                        <!-- Edit Modal -->
                        <div class="modal fade" id="editModal{{ item._id }}" tabindex="-1" aria-labelledby="editModalLabel{{ item._id }}" aria-hidden="true">
                            <div class="modal-dialog modal-lg">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="editModalLabel{{ item._id }}">Edit {{ collection }}</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <form action="/edit/{{ collection }}/{{ item._id }}" method="POST" onsubmit="return confirmEdit()">
                                        <div class="modal-body">
                                          {% if filtered_keys %}
                                            {% for key in filtered_keys %}
                                                 <div class="mb-3">
                                                      <label for="{{ key }}" class="form-label">{{ key }}</label>
                                                     <input type="text" name="{{ key }}" class="form-control"  value="{{ item.get(key) | string if key in item else '' }}" required>
                                                     <select name="types[]" class="form-select mt-2">
                                                        <option value="String" {% if key in key_types and key_types[key] == 'String' %}selected{% endif %}>String</option>
                                                        <option value="int" {% if key in key_types and key_types[key] == 'int' or key_types[key] == 'Int32'%}selected{% endif %}>Integer</option>
                                                        <option value="float" {% if key in key_types and key_types[key] == 'float' or key_types[key] == 'Double' %}selected{% endif %}>Float</option>
                                                        <option value="bool" {% if key in key_types and key_types[key] == 'bool' or key_types[key] == 'Boolean' %}selected{% endif %}>Boolean</option>
                                                        <option value="list" {% if key in key_types and key_types[key] == 'list' or key_types[key] == 'Array' %}selected{% endif %}>List</option>
                                                        <option value="dict" {% if key in key_types and key_types[key] == 'dict' or key_types[key] == 'Object' %}selected{% endif %}>Object</option>
                                                     </select>
                                                  </div>
                                              {% endfor %}
                                            {% else %}
                                                {% for key in keys %}
                                                   <div class="mb-3">
                                                      <label for="{{ key }}" class="form-label">{{ key }}</label>
                                                      <input type="text" name="{{ key }}" class="form-control" value="{{ item.get(key) | string if key in item else '' }}" required>
                                                      <select name="types[]" class="form-select mt-2">
                                                          <option value="String" {% if key in key_types and key_types[key] == 'String' %}selected{% endif %}>String</option>
                                                          <option value="int" {% if key in key_types and key_types[key] == 'int' or key_types[key] == 'Int32' %}selected{% endif %}>Integer</option>
                                                          <option value="float" {% if key in key_types and key_types[key] == 'float' or key_types[key] == 'Double' %}selected{% endif %}>Float</option>
                                                          <option value="bool" {% if key in key_types and key_types[key] == 'bool' or key_types[key] == 'Boolean' %}selected{% endif %}>Boolean</option>
                                                          <option value="list" {% if key in key_types and key_types[key] == 'list' or key_types[key] == 'Array' %}selected{% endif %}>List</option>
                                                          <option value="dict" {% if key in key_types and key_types[key] == 'dict' or key_types[key] == 'Object' %}selected{% endif %}>Object</option>
                                                     </select>
                                                  </div>
                                                {% endfor %}
                                             {% endif %}
                                        </div>
                                        <div class="modal-footer">
                                            <button type="submit" class="btn btn-primary">Save Changes</button>
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                    </tbody>
                </table>
                 <!-- Add Form -->
                    <div class="form-container">
                        <form id="addForm{{ collection }}" action="/add/{{ collection }}" method="POST" class="d-flex gap-2" onsubmit="showToast('Added Successfully')">
                             <input type="hidden" name="collection_name" value="{{ collection }}">
                             {% if filtered_keys %}
                                 {% for key in filtered_keys %}
                                       <input type="text" name="{{ key }}" placeholder="{{ key }}" class="form-control" required>
                                       <select name="types[]" class="form-select mt-2" required>
                                          <option value="String">String</option>
                                           <option value="int">Integer</option>
                                          <option value="float">Float</option>
                                          <option value="bool">Boolean</option>
                                          <option value="list">List</option>
                                          <option value="dict">Object</option>
                                       </select>
                                   {% endfor %}
                                 {% else %}
                                    {% for key in keys %}
                                      <input type="text" name="{{ key }}" placeholder="{{ key }}" class="form-control" required>
                                       <select name="types[]" class="form-select mt-2" required>
                                          <option value="String">String</option>
                                           <option value="int">Integer</option>
                                          <option value="float">Float</option>
                                          <option value="bool">Boolean</option>
                                          <option value="list">List</option>
                                          <option value="dict">Object</option>
                                      </select>
                                    {% endfor %}
                            {% endif %}
                             <button type="submit" class="btn btn-success">Add</button>
                        </form>
                    </div>
            </div>
        </div>
    {% endif %}
</div>

<!-- JavaScript for Alerts -->
<script>
    // Show toast notification
    function showToast(message) {
        const toastMessage = document.getElementById('toastMessage');
        toastMessage.innerText = message;
        const toast = new bootstrap.Toast(document.getElementById('liveToast'));
        toast.show();
    }

    // Confirm delete action
    function confirmDelete() {
        return confirm('Are you sure you want to delete this item?');
    }
    //Confirm delete Key
    function confirmDeleteKey() {
        return confirm('Are you sure you want to delete this Key? This will delete data associated with this key!');
    }

    // Confirm edit action
    function confirmEdit() {
        return confirm('Are you sure you want to edit this item?');
    }

    function addKeyInput(collectionName) {
        const container = document.getElementById(`new-keys-fields${collectionName}`);
        const keyCount = container.querySelectorAll('[id^="key_"]').length;
        const inputDiv = document.createElement('div');
        inputDiv.classList.add('d-flex', 'gap-2','mb-2');


        const keyInput = document.createElement('input');
        keyInput.type = 'text';
        keyInput.name = `key_${keyCount}`;
        keyInput.id =`key_${keyCount}`;
        keyInput.placeholder = 'Enter Key';
        keyInput.classList.add('form-control');

        const valueInput = document.createElement('input');
        valueInput.type = 'text';
        valueInput.name = `value_${keyCount}`;
        valueInput.id =`value_${keyCount}`;
        valueInput.placeholder = 'Enter value';
        valueInput.classList.add('form-control');

         const typeSelect = document.createElement('select');
            typeSelect.name = `type_${keyCount}`;
             typeSelect.classList.add('form-select');
              const types = ["String","int","float","bool","list","dict"];
             types.forEach( type => {
                 const option = document.createElement("option");
                 option.value = type;
                 option.text = type;
                typeSelect.appendChild(option)
                })


        inputDiv.appendChild(keyInput);
        inputDiv.appendChild(valueInput);
          inputDiv.appendChild(typeSelect)

        container.appendChild(inputDiv);
    }
    function toggleKeyRenameForm(collection, key, button) {
        const form = document.getElementById(`renameKeyForm${collection}${key}`);
        form.classList.toggle('show');
         const input = form.querySelector('input[name="new_key"]');
        if (form.classList.contains('show')) {
            input.focus()
        }
        else {
            button.focus();
        }
    }

    function confirmRenameKey(form) {
        return confirm('Are you sure you want to rename this Key?');
    }
</script>
</body>
</html>